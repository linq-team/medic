{{- if .Values.grafana.dashboard.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "medic.fullname" . }}-grafana-dashboard
  namespace: {{ include "medic.namespace" . }}
  labels:
    {{- include "medic.labels" . | nindent 4 }}
    {{- range $key, $value := .Values.grafana.dashboard.labels }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
  {{- with .Values.grafana.dashboard.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  medic-overview.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Overview dashboard for Medic heartbeat monitoring service with trace and log correlation",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [
        {
          "asDropdown": false,
          "icon": "external link",
          "includeVars": true,
          "keepTime": true,
          "tags": [],
          "targetBlank": true,
          "title": "Explore Traces",
          "tooltip": "View traces in Tempo",
          "type": "link",
          "url": "/explore?orgId=1&left=%7B%22datasource%22:%22tempo%22%7D"
        },
        {
          "asDropdown": false,
          "icon": "external link",
          "includeVars": true,
          "keepTime": true,
          "tags": [],
          "targetBlank": true,
          "title": "Explore Logs",
          "tooltip": "View logs in Loki",
          "type": "link",
          "url": "/explore?orgId=1&left=%7B%22datasource%22:%22loki%22%7D"
        }
      ],
      "panels": [
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "id": 100,
          "panels": [],
          "title": "Service Overview",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
          "id": 1,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
            "textMode": "auto"
          },
          "pluginVersion": "10.2.0",
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${datasource}" },
              "editorMode": "code",
              "expr": "sum(rate(medic_http_server_request_total{service_name=~\"$service\"}[$__rate_interval]))",
              "legendFormat": "Request Rate",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Request Rate",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "max": 1, "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.01 },
                  { "color": "red", "value": 0.05 }
                ]
              },
              "unit": "percentunit"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
          "id": 2,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
            "textMode": "auto"
          },
          "pluginVersion": "10.2.0",
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${datasource}" },
              "editorMode": "code",
              "expr": "sum(rate(medic_http_server_request_total{status_code=~\"5..\", service_name=~\"$service\"}[$__rate_interval])) / sum(rate(medic_http_server_request_total{service_name=~\"$service\"}[$__rate_interval]))",
              "legendFormat": "Error Rate",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Error Rate (5xx)",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.5 },
                  { "color": "red", "value": 2 }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
          "id": 3,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
            "textMode": "auto"
          },
          "pluginVersion": "10.2.0",
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${datasource}" },
              "editorMode": "code",
              "expr": "histogram_quantile(0.99, sum(rate(medic_http_server_request_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le))",
              "legendFormat": "p99 Latency",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "p99 Latency",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 1 },
                  { "color": "red", "value": 5 }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 1 },
          "id": 4,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
            "textMode": "auto"
          },
          "pluginVersion": "10.2.0",
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${datasource}" },
              "editorMode": "code",
              "expr": "medic_alerts_active",
              "legendFormat": "Active Alerts",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Active Alerts",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
          "id": 101,
          "panels": [],
          "title": "Request Metrics",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
          "id": 5,
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${datasource}" },
              "editorMode": "code",
              "expr": "sum(rate(medic_http_server_request_total{service_name=~\"$service\"}[$__rate_interval])) by (route)",
              "legendFormat": "{{`{{ route }}`}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Request Rate by Endpoint",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "reqps"
            },
            "overrides": [
              { "matcher": { "id": "byRegexp", "options": "^2.." }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
              { "matcher": { "id": "byRegexp", "options": "^4.." }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
              { "matcher": { "id": "byRegexp", "options": "^5.." }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
            ]
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
          "id": 6,
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${datasource}" },
              "editorMode": "code",
              "expr": "sum(rate(medic_http_server_request_total{service_name=~\"$service\"}[$__rate_interval])) by (status_code)",
              "legendFormat": "{{`{{ status_code }}`}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Request Rate by Status Code",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 },
          "id": 102,
          "panels": [],
          "title": "Latency (with Trace Exemplars)",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "line" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 2 }] },
              "unit": "s"
            },
            "overrides": [
              { "matcher": { "id": "byName", "options": "p99" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "p95" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "p50" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }
            ]
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 15 },
          "id": 7,
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "exemplar": true, "expr": "histogram_quantile(0.50, sum(rate(medic_http_server_request_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le))", "legendFormat": "p50", "range": true, "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "exemplar": true, "expr": "histogram_quantile(0.95, sum(rate(medic_http_server_request_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le))", "legendFormat": "p95", "range": true, "refId": "B" },
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "exemplar": true, "expr": "histogram_quantile(0.99, sum(rate(medic_http_server_request_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le))", "legendFormat": "p99", "range": true, "refId": "C" }
          ],
          "title": "Request Latency Percentiles",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 15 },
          "id": 8,
          "links": [{ "targetBlank": true, "title": "View Trace", "url": "/explore?orgId=1&left=%7B%22datasource%22:%22${tempo_datasource}%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22query%22:%22${__data.fields.trace_id}%22,%22queryType%22:%22traceql%22%7D%5D%7D" }],
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "exemplar": true, "expr": "histogram_quantile(0.99, sum(rate(medic_http_server_request_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le, route))", "legendFormat": "{{`{{ route }}`}}", "range": true, "refId": "A" }
          ],
          "title": "p99 Latency by Endpoint (with Exemplars)",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 23 },
          "id": 103,
          "panels": [],
          "title": "Auth & Rate Limiting",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
          "id": 9,
          "options": {
            "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "sum(rate(medic_auth_failures_total[$__rate_interval])) by (reason)", "legendFormat": "{{`{{ reason }}`}}", "range": true, "refId": "A" }
          ],
          "title": "Auth Failures by Reason",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
          "id": 10,
          "links": [{ "targetBlank": true, "title": "View Logs", "url": "/explore?orgId=1&left=%7B%22datasource%22:%22${loki_datasource}%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bservice_name%3D%5C%22${service}%5C%22%7D%20%7C%3D%20%5C%22rate_limit%5C%22%22%7D%5D,%22range%22:%7B%22from%22:%22${__from}%22,%22to%22:%22${__to}%22%7D%7D" }],
          "options": {
            "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "sum(rate(medic_http_server_request_total{status_code=\"429\", service_name=~\"$service\"}[$__rate_interval])) by (route)", "legendFormat": "{{`{{ route }}`}}", "range": true, "refId": "A" }
          ],
          "title": "Rate Limit Hits (429s) by Endpoint",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 32 },
          "id": 104,
          "panels": [],
          "title": "Playbook Executions",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "short"
            },
            "overrides": [
              { "matcher": { "id": "byName", "options": "completed" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "failed" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "cancelled" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }
            ]
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 33 },
          "id": 11,
          "links": [{ "targetBlank": true, "title": "View Logs", "url": "/explore?orgId=1&left=%7B%22datasource%22:%22${loki_datasource}%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bservice_name%3D%5C%22${service}%5C%22%7D%20%7C%3D%20%5C%22playbook%5C%22%22%7D%5D,%22range%22:%7B%22from%22:%22${__from}%22,%22to%22:%22${__to}%22%7D%7D" }],
          "options": {
            "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "sum(rate(medic_playbook_executions_total{service_name=~\"$service\"}[$__rate_interval])) by (status)", "legendFormat": "{{`{{ status }}`}}", "range": true, "refId": "A" }
          ],
          "title": "Playbook Executions by Status",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 33 },
          "id": 12,
          "links": [{ "targetBlank": true, "title": "View Trace", "url": "/explore?orgId=1&left=%7B%22datasource%22:%22${tempo_datasource}%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22query%22:%22${__data.fields.trace_id}%22,%22queryType%22:%22traceql%22%7D%5D%7D" }],
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "exemplar": true, "expr": "histogram_quantile(0.95, sum(rate(medic_playbook_execution_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le, playbook))", "legendFormat": "{{`{{ playbook }}`}}", "range": true, "refId": "A" }
          ],
          "title": "Playbook Execution Duration p95 (with Exemplars)",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 41 },
          "id": 105,
          "panels": [],
          "title": "Webhooks & External Services",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "max": 1, "min": 0,
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 0.9 }, { "color": "green", "value": 0.99 }] },
              "unit": "percentunit"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 8, "x": 0, "y": 42 },
          "id": 13,
          "options": { "minVizHeight": 75, "minVizWidth": 75, "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showThresholdLabels": false, "showThresholdMarkers": true, "sizing": "auto" },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "sum(rate(medic_pagerduty_requests_total{status=\"success\"}[$__rate_interval])) / sum(rate(medic_pagerduty_requests_total[$__rate_interval]))", "legendFormat": "PagerDuty", "range": true, "refId": "A" }
          ],
          "title": "PagerDuty Success Rate",
          "type": "gauge"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "max": 1, "min": 0,
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 0.9 }, { "color": "green", "value": 0.99 }] },
              "unit": "percentunit"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 8, "x": 8, "y": 42 },
          "id": 14,
          "options": { "minVizHeight": 75, "minVizWidth": 75, "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showThresholdLabels": false, "showThresholdMarkers": true, "sizing": "auto" },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "sum(rate(medic_slack_requests_total{status=\"success\"}[$__rate_interval])) / sum(rate(medic_slack_requests_total[$__rate_interval]))", "legendFormat": "Slack", "range": true, "refId": "A" }
          ],
          "title": "Slack Success Rate",
          "type": "gauge"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 8, "x": 16, "y": 42 },
          "id": 15,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "medic_circuit_breaker_open", "legendFormat": "Open Circuits", "range": true, "refId": "A" }
          ],
          "title": "Circuit Breakers Open",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 50 },
          "id": 106,
          "panels": [],
          "title": "Health & Infrastructure",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [{ "options": { "0": { "color": "red", "index": 1, "text": "Unhealthy" }, "1": { "color": "green", "index": 0, "text": "Healthy" } }, "type": "value" }],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 6, "w": 12, "x": 0, "y": 51 },
          "id": 16,
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "horizontal", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "expr": "medic_health_status", "legendFormat": "{{`{{ component }}`}}", "range": true, "refId": "A" }
          ],
          "title": "Component Health",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text",
                "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line",
                "fillOpacity": 10, "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5,
                "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" }
              },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": { "h": 6, "w": 12, "x": 12, "y": 51 },
          "id": 17,
          "links": [{ "targetBlank": true, "title": "View Trace", "url": "/explore?orgId=1&left=%7B%22datasource%22:%22${tempo_datasource}%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22query%22:%22${__data.fields.trace_id}%22,%22queryType%22:%22traceql%22%7D%5D%7D" }],
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "multi", "sort": "desc" }
          },
          "pluginVersion": "10.2.0",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "${datasource}" }, "editorMode": "code", "exemplar": true, "expr": "histogram_quantile(0.95, sum(rate(medic_db_client_operation_duration_seconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (le, operation))", "legendFormat": "{{`{{ operation }}`}}", "range": true, "refId": "A" }
          ],
          "title": "Database Query Duration p95 (with Exemplars)",
          "type": "timeseries"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 39,
      "tags": ["medic", "observability", "otel"],
      "templating": {
        "list": [
          { "current": { "selected": false, "text": "Prometheus", "value": "prometheus" }, "hide": 0, "includeAll": false, "label": "Prometheus", "multi": false, "name": "datasource", "options": [], "query": "prometheus", "queryValue": "", "refresh": 1, "regex": "", "skipUrlSync": false, "type": "datasource" },
          { "current": { "selected": false, "text": "Tempo", "value": "tempo" }, "hide": 0, "includeAll": false, "label": "Tempo", "multi": false, "name": "tempo_datasource", "options": [], "query": "tempo", "queryValue": "", "refresh": 1, "regex": "", "skipUrlSync": false, "type": "datasource" },
          { "current": { "selected": false, "text": "Loki", "value": "loki" }, "hide": 0, "includeAll": false, "label": "Loki", "multi": false, "name": "loki_datasource", "options": [], "query": "loki", "queryValue": "", "refresh": 1, "regex": "", "skipUrlSync": false, "type": "datasource" },
          { "current": { "selected": false, "text": "production", "value": "production" }, "datasource": { "type": "prometheus", "uid": "${datasource}" }, "definition": "label_values(medic_build_info, deployment_environment)", "hide": 0, "includeAll": false, "label": "Environment", "multi": false, "name": "environment", "options": [], "query": { "qryType": 1, "query": "label_values(medic_build_info, deployment_environment)", "refId": "PrometheusVariableQueryEditor-VariableQuery" }, "refresh": 2, "regex": "", "skipUrlSync": false, "sort": 1, "type": "query" },
          { "current": { "selected": false, "text": "medic", "value": "medic" }, "datasource": { "type": "prometheus", "uid": "${datasource}" }, "definition": "label_values(medic_build_info, service_name)", "hide": 0, "includeAll": true, "label": "Service", "multi": false, "name": "service", "options": [], "query": { "qryType": 1, "query": "label_values(medic_build_info, service_name)", "refId": "PrometheusVariableQueryEditor-VariableQuery" }, "refresh": 2, "regex": "", "skipUrlSync": false, "sort": 1, "type": "query" }
        ]
      },
      "time": { "from": "now-1h", "to": "now" },
      "timepicker": { "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"] },
      "timezone": "browser",
      "title": "Medic Overview",
      "uid": "medic-overview",
      "version": 1,
      "weekStart": ""
    }
{{- end }}
