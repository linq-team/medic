# Default values for medic Helm chart
# This is a YAML-formatted file.

# Global settings
global:
  environment: production

# Namespace configuration
namespace:
  create: false
  name: medic

# Container image settings
image:
  repository: medic
  tag: "latest"
  pullPolicy: IfNotPresent

# Image pull secrets for private registries
imagePullSecrets: []

# Override the chart name
nameOverride: ""
fullnameOverride: ""

# API deployment configuration
api:
  replicaCount: 2

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Liveness probe configuration
  livenessProbe:
    httpGet:
      path: /health/live
      port: http
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Readiness probe configuration
  readinessProbe:
    httpGet:
      path: /health/ready
      port: http
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

  # KEDA autoscaling configuration
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    cooldownPeriod: 300
    pollingInterval: 30
    triggers:
      cpu:
        threshold: 70
      prometheus:
        enabled: false
        serverAddress: http://prometheus:9090
        metricName: http_requests_per_second
        threshold: "100"
        query: sum(rate(http_requests_total{service="medic-api"}[1m]))

# Worker deployment configuration
worker:
  replicaCount: 1

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Liveness probe for worker
  livenessProbe:
    exec:
      command:
        - python
        - -c
        - "import sys; sys.exit(0)"
    initialDelaySeconds: 30
    periodSeconds: 60
    timeoutSeconds: 10
    failureThreshold: 3

  # PodDisruptionBudget for worker
  pdb:
    enabled: false
    minAvailable: 1

# Service configuration
service:
  type: ClusterIP
  port: 8080

# Ingress configuration
ingress:
  enabled: false
  className: alb
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
  host: medic.example.com
  tls:
    enabled: false
    # AWS Certificate Manager ARN (for ALB)
    certificateArn: ""
    # Kubernetes TLS secret name (for non-ALB ingress controllers)
    secretName: ""

# ConfigMap for non-sensitive configuration
config:
  PORT: "8080"
  DEBUG: "false"
  LOG_LEVEL: "INFO"
  MEDIC_TIMEZONE: "America/Chicago"
  WORKER_INTERVAL_SECONDS: "60"
  ALERT_AUTO_UNMUTE_HOURS: "24"
  MEDIC_LOG_FORMAT: "json"
  # Rate limiting defaults
  RATE_LIMIT_DEFAULT_REQUESTS: "100"
  RATE_LIMIT_DEFAULT_WINDOW_SECONDS: "60"
  RATE_LIMIT_HEALTH_REQUESTS: "1000"
  RATE_LIMIT_METRICS_REQUESTS: "100"
  RATE_LIMIT_DOCS_REQUESTS: "60"
  MEDIC_RATE_LIMITER_TYPE: "auto"

# Secret management
secret:
  # Create a Secret resource (for non-ESO deployments)
  create: false
  # Secret values (only used if create: true)
  values: {}
    # MEDIC_SECRETS_KEY: ""
    # DATABASE_URL: ""
    # REDIS_URL: ""

# External Secrets Operator integration
externalSecret:
  enabled: false
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  # Keys to fetch from external secret store
  keys:
    - secretKey: MEDIC_SECRETS_KEY
      remoteRef:
        key: medic/production/secrets
        property: MEDIC_SECRETS_KEY
    - secretKey: DATABASE_URL
      remoteRef:
        key: medic/production/secrets
        property: DATABASE_URL
    - secretKey: REDIS_URL
      remoteRef:
        key: medic/production/secrets
        property: REDIS_URL
    - secretKey: MEDIC_ADMIN_API_KEY
      remoteRef:
        key: medic/production/secrets
        property: MEDIC_ADMIN_API_KEY
    - secretKey: SLACK_API_TOKEN
      remoteRef:
        key: medic/production/secrets
        property: SLACK_API_TOKEN
    - secretKey: SLACK_SIGNING_SECRET
      remoteRef:
        key: medic/production/secrets
        property: SLACK_SIGNING_SECRET
    - secretKey: PAGERDUTY_ROUTING_KEY
      remoteRef:
        key: medic/production/secrets
        property: PAGERDUTY_ROUTING_KEY

# ServiceAccount configuration
serviceAccount:
  create: true
  name: ""
  # Annotations for IRSA (IAM Roles for Service Accounts)
  annotations: {}
    # eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/medic-role

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity and topology spread
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: medic
          topologyKey: kubernetes.io/hostname

# Topology spread constraints for multi-AZ distribution
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: medic

# Metrics and monitoring
metrics:
  serviceMonitor:
    enabled: false
    # Scrape interval (default: 30s)
    interval: 30s
    # Scrape timeout (default: 10s)
    scrapeTimeout: 10s
    # Additional labels to add to the ServiceMonitor
    labels: {}
    # Honor labels from the scraped metrics
    honorLabels: false
    # Enable exemplar scraping for trace correlation in Grafana
    enableExemplars: true
    # Metric relabeling configuration
    metricRelabelings: []
    # Add OTEL resource attributes as metric labels
    # - sourceLabels: [__name__]
    #   regex: 'medic_.*'
    #   action: keep
    # Relabeling configuration for discovered targets
    relabelings: []
  # PodMonitor for worker (if it exposes metrics)
  podMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
    labels: {}
    honorLabels: false
    metricRelabelings: []
    relabelings: []

# Grafana dashboard
grafana:
  dashboard:
    # Enable dashboard ConfigMap creation for Grafana sidecar discovery
    enabled: false
    # Labels for Grafana sidecar to discover the dashboard
    labels:
      grafana_dashboard: "1"
    # Additional annotations for the ConfigMap
    annotations: {}
    # Datasource configuration for the dashboard
    # These are used as default values for dashboard variables
    datasources:
      prometheus: prometheus
      tempo: tempo
      loki: loki

# Database migration job (runs as Helm pre-upgrade/pre-install hook)
migrations:
  # Enable migration job
  enabled: false
  # Resource requests and limits for the migration job
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Number of retries before considering the job failed
  backoffLimit: 3
  # Maximum time (seconds) for the job to complete
  activeDeadlineSeconds: 300
  # TTL (seconds) after job completion for automatic cleanup
  ttlSecondsAfterFinished: 86400
  # Additional command arguments for the migration script
  args: []
  # Example: ["--verbose"]
