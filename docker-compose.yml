# =============================================================================
# Medic Docker Compose for Local Development
# =============================================================================
# Usage:
#   1. Copy .env.example to .env and fill in values
#   2. Run: docker-compose up -d
#   3. Access API at http://localhost:8080
#   4. Access UI at http://localhost:80
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15
    container_name: medic-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${PG_USER:-medic}
      POSTGRES_PASSWORD: ${PG_PASS:-medic_dev_password}
      POSTGRES_DB: ${DB_NAME:-medic}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-medic} -d ${DB_NAME:-medic}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - medic-network

  # ---------------------------------------------------------------------------
  # Redis (for distributed rate limiting)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7
    container_name: medic-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    command: redis-server --appendonly yes
    networks:
      - medic-network

  # ---------------------------------------------------------------------------
  # Medic API Server
  # ---------------------------------------------------------------------------
  medic-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: medic-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-medic}
      PG_USER: ${PG_USER:-medic}
      PG_PASS: ${PG_PASS:-medic_dev_password}
      # Application configuration
      PORT: 8080
      MEDIC_BASE_URL: ${MEDIC_BASE_URL:-http://localhost:8080}
      MEDIC_TIMEZONE: ${MEDIC_TIMEZONE:-America/Chicago}
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Redis configuration (for distributed rate limiting)
      REDIS_URL: redis://redis:6379/0
      MEDIC_RATE_LIMITER_TYPE: ${MEDIC_RATE_LIMITER_TYPE:-auto}
      # Slack configuration (optional)
      SLACK_API_TOKEN: ${SLACK_API_TOKEN:-}
      SLACK_CHANNEL_ID: ${SLACK_CHANNEL_ID:-}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET:-}
      # PagerDuty configuration (optional)
      PAGERDUTY_ROUTING_KEY: ${PAGERDUTY_ROUTING_KEY:-}
      # Security configuration
      MEDIC_SECRETS_KEY: ${MEDIC_SECRETS_KEY:-}
      MEDIC_WEBHOOK_SECRET: ${MEDIC_WEBHOOK_SECRET:-}
      MEDIC_ALLOWED_WEBHOOK_HOSTS: ${MEDIC_ALLOWED_WEBHOOK_HOSTS:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      medic-network:
        aliases:
          - medic-api

  # ---------------------------------------------------------------------------
  # Medic Worker (background monitoring process)
  # ---------------------------------------------------------------------------
  medic-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: medic-worker
    restart: unless-stopped
    command: ["python", "-m", "Medic.Worker.monitor"]
    environment:
      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-medic}
      PG_USER: ${PG_USER:-medic}
      PG_PASS: ${PG_PASS:-medic_dev_password}
      # Application configuration
      MEDIC_BASE_URL: ${MEDIC_BASE_URL:-http://localhost:8080}
      MEDIC_TIMEZONE: ${MEDIC_TIMEZONE:-America/Chicago}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      WORKER_INTERVAL_SECONDS: ${WORKER_INTERVAL_SECONDS:-15}
      ALERT_AUTO_UNMUTE_HOURS: ${ALERT_AUTO_UNMUTE_HOURS:-24}
      # Redis configuration
      REDIS_URL: redis://redis:6379/0
      # Slack configuration (optional)
      SLACK_API_TOKEN: ${SLACK_API_TOKEN:-}
      SLACK_CHANNEL_ID: ${SLACK_CHANNEL_ID:-}
      # PagerDuty configuration (optional)
      PAGERDUTY_ROUTING_KEY: ${PAGERDUTY_ROUTING_KEY:-}
      # Security configuration
      MEDIC_SECRETS_KEY: ${MEDIC_SECRETS_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - medic-network

  # ---------------------------------------------------------------------------
  # Medic UI (React dashboard)
  # ---------------------------------------------------------------------------
  medic-ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: medic-ui
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      medic-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - medic-network

networks:
  medic-network:
    driver: bridge

# -----------------------------------------------------------------------------
# Persistent Volumes
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
