## Codebase Patterns
- Use `Medic.Helpers.logSettings.logSetup()` for logging configuration
- Follow existing module docstring pattern with description, features, and usage example
- Use `@dataclass` for configuration and status objects
- Test pattern: class-based tests with `@patch` decorators for mocking
- Use `pytest.mark.parametrize` for testing multiple inputs
- Import database module as `import Medic.Core.database as db`
- Module constants should be type-annotated: `CONSTANT: Type = value`

---

## 2026-02-03 22:00 - US-001 - Linear Issue: SRE-28
- **What was implemented**: URL validator module for SSRF prevention
  - Created `Medic/Core/url_validator.py` with:
    - `InvalidURLError` exception class
    - `validate_url(url: str, skip_dns_check: bool = False) -> bool` function
    - `is_private_ip(ip: str) -> bool` helper function
    - `is_safe_url(url: str) -> bool` convenience wrapper
    - `get_allowed_hosts() -> Optional[Set[str]]` for env var support
    - `resolve_hostname(hostname: str) -> List[str]` for DNS rebinding prevention
  - Blocks private IP ranges: 127.0.0.0/8, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 169.254.0.0/16, 0.0.0.0/8
  - Blocks IPv6 private ranges: ::1/128, fc00::/7, fe80::/10, ::/128
  - Blocks localhost, 0.0.0.0, cloud metadata (169.254.169.254)
  - Only allows http/https schemes
  - Performs DNS resolution to catch DNS rebinding attacks
  - Supports `MEDIC_ALLOWED_WEBHOOK_HOSTS` env var for explicit allowlist
  - Error messages are generic to prevent information leakage

- **Files changed**:
  - `Medic/Core/url_validator.py` (new)
  - `tests/unit/test_url_validator.py` (new, 128 tests)
  - `tasks/prd.json` (updated passes: true)

- **Learnings for future iterations**:
  - The codebase uses `logger.log(level=30, msg="...")` pattern instead of `logger.warning()`
  - Type annotations are important - mypy is strict about List types needing explicit annotation
  - IPv6 networks need separate handling from IPv4 networks in type annotations
  - Tests should use `skip_dns_check=True` when testing URL validation without network calls
  - `socket.getaddrinfo` returns tuples where index [4][0] is the IP address
  - Use `patch.dict('os.environ', {...})` for testing environment variables

---

## 2026-02-03 23:15 - US-002 - Linear Issue: SRE-29
- **What was implemented**: Integrated URL validator into webhook execution
  - Added `from Medic.Core.url_validator import InvalidURLError, validate_url` to `playbook_engine.py`
  - Call `validate_url(url)` in `execute_webhook_step()` after variable substitution, before HTTP request
  - On `InvalidURLError`, return `StepResult` with `FAILED` status and "Invalid webhook URL" message
  - Added `from Medic.Core.url_validator import InvalidURLError, validate_url` to `webhook_delivery.py`
  - Call `validate_url(url)` in `_send_request()` before HTTP request
  - Log validation failures at WARNING level using `logger.warning()`
  - Added 11 integration tests (5 in test_playbook_engine.py, 6 in test_webhook_delivery.py)

- **Files changed**:
  - `Medic/Core/playbook_engine.py` (import + validation in execute_webhook_step)
  - `Medic/Core/webhook_delivery.py` (import + validation in _send_request)
  - `tests/unit/test_playbook_engine.py` (new TestExecuteWebhookStepSSRFPrevention class)
  - `tests/unit/test_webhook_delivery.py` (new TestWebhookDeliveryServiceSSRFPrevention class)
  - `tasks/prd.json` (updated passes: true)

- **Learnings for future iterations**:
  - URL validation should happen AFTER variable substitution so ${secrets.XXX} and ${VAR} are resolved first
  - Use `@patch('Medic.Core.module.validate_url')` to mock URL validation in tests
  - The playbook_engine uses `StepResult` dataclass for return values with specific status codes
  - webhook_delivery uses `DeliveryResult` dataclass with `success` and `error_message` fields
  - When validation fails, HTTP client should NOT be called - verify with `mock_client.assert_not_called()`

---
