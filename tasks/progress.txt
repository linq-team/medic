# Ralph Progress Log
# Project: Medic Terraform Self-Contained Deployment
# Branch: feature/terraform-self-contained-deployment
# Started: 2026-02-05

## Codebase Patterns
- Terraform files use `terraform fmt` canonical style (single space before inline comments, aligned `=` signs)
- Multi-region architecture: ECR in us-east-1, EKS/RDS/Secrets Manager in us-east-2
- S3 state backend region is passed via `-backend-config="region=${{ env.AWS_REGION }}"` in workflows
- cd-eks.yml explicitly uses `--region us-east-1` for ECR image checks
- `ruff` and `mypy` are available via `python3 -m ruff` / `python3 -m mypy` (not in PATH directly)
- Pre-existing mypy warnings in `scripts/init_api_keys.py` (Python 3.10 union syntax) — not blocking
- Backend.tf files only set `encrypt = true`; all other backend config (bucket, key, region, DynamoDB) comes via `-backend-config` flags in workflows
- Dev environment points to `dev-o11y-terraform-state` bucket (future dev-o11y-tf cluster); prod points to `o11y-prod-terraform-state`
- Dev ingress host is `dev-medic.linqapp.com`; prod is `medic.linqapp.com`
- ACM module uses DNS validation (not email) — requires adding CNAME to Cloudflare manually after `terraform apply`

---

## 2026-02-05 - US-001 - Linear Issue: SRE-147
- **What was implemented:** Fixed region mismatch in terraform.yml workflow — changed `AWS_REGION` from `us-east-1` to `us-east-2` to match EKS cluster region. Also ran `terraform fmt` across all modules to fix pre-existing formatting inconsistencies.
- **Files changed:**
  - `.github/workflows/terraform.yml` — AWS_REGION us-east-1 → us-east-2
  - `terraform/environments/dev/main.tf` — terraform fmt alignment
  - `terraform/environments/prod/main.tf` — terraform fmt alignment
  - `terraform/environments/prod/variables.tf` — terraform fmt comment spacing
  - `terraform/modules/elasticache/main.tf` — terraform fmt alignment
  - `terraform/modules/elasticache/variables.tf` — terraform fmt comment spacing
  - `terraform/modules/secrets/main.tf` — terraform fmt alignment
- **Learnings for future iterations:**
  - `cd-eks.yml` was already correct with `AWS_REGION: us-east-2` — only `terraform.yml` had the mismatch
  - Both `terraform/environments/*/variables.tf` already had `aws_region` defaulting to `us-east-2`
  - Multiple terraform files had pre-existing format issues (extra spaces before inline comments) — `terraform fmt` is not being enforced in pre-commit hooks
  - YAML validation works via `python3 -c "import yaml; yaml.safe_load(...)"`
---

## 2026-02-05 - US-002 - Linear Issue: SRE-147
- **What was implemented:** Updated backend.tf comments in both dev and prod environments to clearly document the shared S3 backend with environment-specific key prefixes. Fixed prod backend.tf which incorrectly referenced `dev` in its key comment.
- **Files changed:**
  - `terraform/environments/dev/backend.tf` — Updated header and inline comments to document shared backend (bucket, DynamoDB, dev key prefix)
  - `terraform/environments/prod/backend.tf` — Updated header and inline comments to document shared backend (bucket, DynamoDB, prod key prefix); fixed key comment from `dev` to `prod`
- **Learnings for future iterations:**
  - The S3 state key pattern `$TF_STATE_KEY/$TF_ENVIRONMENT/terraform.tfstate` is configured in the workflow files, not in backend.tf — backend.tf only has `encrypt = true` since all other values come via `-backend-config` flags
  - Original prod backend.tf had a copy-paste bug: key comment said `TF_STATE_KEY/dev/terraform.tfstate` instead of `prod`
  - Backend configuration is entirely driven by CI/CD `-backend-config` flags — the backend.tf files are documentation-only beyond `encrypt = true`
---

## 2026-02-05 - US-003 - Linear Issue: SRE-147
- **What was implemented:** Configured dev environment to reference the future `dev-o11y-tf` cluster remote state instead of the prod `o11y-prod-terraform-state` bucket. Updated `o11y_state_bucket` default to `dev-o11y-terraform-state`, changed `ingress_host` to `dev-medic.linqapp.com`, and added clear comments in both `variables.tf` and `main.tf` explaining that the dev environment will fail until the dev-o11y-tf cluster is provisioned.
- **Files changed:**
  - `terraform/environments/dev/variables.tf` — Changed `o11y_state_bucket` default from `o11y-prod-terraform-state` to `dev-o11y-terraform-state`; updated `ingress_host` from `medic.internal.linqapp.com` to `dev-medic.linqapp.com`; added NOTE comments about dev-o11y-tf not existing yet
  - `terraform/environments/dev/main.tf` — Updated header and remote state section comments to reference dev-o11y-tf; added NOTE about environment failing until dev cluster is provisioned
- **Learnings for future iterations:**
  - Dev `ingress_host` was previously `medic.internal.linqapp.com` (not a dev-specific hostname) — prod already had the correct `medic.linqapp.com`
  - The `o11y_state_bucket` variable drives the remote state lookup — changing it is sufficient to point dev at a different cluster's state
  - Prod environment should NOT be modified for this story — it correctly references `o11y-prod-terraform-state`
---

## 2026-02-05 - US-004 - Linear Issue: SRE-147
- **What was implemented:** Created reusable ACM certificate Terraform module at `terraform/modules/acm/` with DNS validation for TLS termination. Module creates an ACM certificate and outputs the certificate ARN plus CNAME validation records for Cloudflare DNS setup.
- **Files changed:**
  - `terraform/modules/acm/main.tf` — ACM certificate resource with DNS validation and `create_before_destroy` lifecycle
  - `terraform/modules/acm/variables.tf` — `domain_name` (required) and `tags` (optional) variables
  - `terraform/modules/acm/outputs.tf` — `certificate_arn`, `domain_validation_options`, `domain_name`, `validation_cname_name`, `validation_cname_value` outputs
- **Learnings for future iterations:**
  - Existing modules follow a consistent pattern: header comment block with `=====`, section dividers with `-----`, `merge(var.tags, {...})` for tag merging
  - ACM DNS validation always creates a single CNAME record — `one()` function extracts it cleanly from `domain_validation_options`
  - `create_before_destroy` lifecycle is important for ACM certificates to avoid downtime during rotation
  - The module intentionally does NOT include `aws_acm_certificate_validation` resource — validation is done externally via Cloudflare DNS (not managed by Terraform)
---

