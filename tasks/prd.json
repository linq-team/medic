{
  "project": "Medic",
  "branchName": "feature/terraform-self-contained-deployment",
  "description": "Make Medic's Terraform deployment fully self-contained with ACM certificates, ClusterSecretStore, proper CD triggers (PR→dev, merge→prod), and comprehensive documentation.",
  "prdFile": "tasks/prd-terraform-self-contained-deployment.md",
  "gitWorkflow": {
    "baseBranch": "main",
    "pullBeforeStart": true,
    "commitMessageFormat": "${message}"
  },
  "requirements": {
    "updateTests": false,
    "typecheckRequired": false,
    "lintRequired": true,
    "allTestsMustPass": true
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix Region Mismatch in CI/CD Workflows",
      "description": "As a DevOps engineer, I want consistent AWS region configuration so that Terraform and CD workflows don't fail due to mismatched regions.",
      "acceptanceCriteria": [
        "Update `terraform.yml` to use `AWS_REGION: us-east-2` (matches EKS cluster region)",
        "Update `cd-eks.yml` to use `AWS_REGION: us-east-2` consistently",
        "ECR image check in `cd-eks.yml` explicitly uses `--region us-east-1` (where ECR lives)",
        "All Terraform variable defaults in `terraform/environments/*/variables.tf` use `us-east-2`",
        "Terraform fmt passes",
        "YAML lint passes on workflow files"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation fix - must be done first. ECR is in us-east-1, EKS/RDS/Secrets in us-east-2."
    },
    {
      "id": "US-002",
      "title": "Update Remote State Configuration for Shared Backend",
      "description": "As a DevOps engineer, I want both environments to share the same S3 bucket and DynamoDB table with different key prefixes.",
      "acceptanceCriteria": [
        "Dev environment uses state key `medic/dev/terraform.tfstate`",
        "Prod environment uses state key `medic/prod/terraform.tfstate`",
        "Both use same S3 bucket (`medic-terraform-state-018143940435`)",
        "Both use same DynamoDB table (`medic-terraform-locks`)",
        "Update `terraform/environments/dev/backend.tf` comments to reflect shared backend",
        "Update `terraform/environments/prod/backend.tf` comments to reflect shared backend",
        "Terraform fmt passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Shared backend with different prefixes per environment."
    },
    {
      "id": "US-003",
      "title": "Configure Dev Environment for Future dev-o11y-tf Cluster",
      "description": "As a DevOps engineer, I want the dev environment configured for the future dev-o11y-tf cluster so it works automatically when created.",
      "acceptanceCriteria": [
        "Update `terraform/environments/dev/variables.tf` to reference `dev-o11y-tf` remote state bucket",
        "Add variable `o11y_state_bucket` default to dev-specific bucket name",
        "Update `ingress_host` default to `dev-medic.linqapp.com`",
        "Add comments explaining dev will fail until dev-o11y-tf cluster is provisioned",
        "Terraform fmt passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Dev cluster doesn't exist yet. Configure now, will fail gracefully until cluster created."
    },
    {
      "id": "US-004",
      "title": "Create ACM Certificate Module",
      "description": "As a DevOps engineer, I want ACM certificates created by Terraform so TLS is configured without manual certificate provisioning.",
      "acceptanceCriteria": [
        "Create `terraform/modules/acm/main.tf` with `aws_acm_certificate` resource",
        "Certificate uses DNS validation method",
        "Create `terraform/modules/acm/variables.tf` with `domain_name` and `tags` variables",
        "Create `terraform/modules/acm/outputs.tf` outputting `certificate_arn` and `domain_validation_options`",
        "Output includes CNAME name and value for Cloudflare DNS setup",
        "Terraform fmt passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Reusable module for ACM certificates with DNS validation."
    },
    {
      "id": "US-005",
      "title": "Integrate ACM Module into Environments",
      "description": "As a DevOps engineer, I want ACM certificates created per environment with proper domain names.",
      "acceptanceCriteria": [
        "Add ACM module to `terraform/environments/dev/main.tf` for `dev-medic.linqapp.com`",
        "Add ACM module to `terraform/environments/prod/main.tf` for `medic.linqapp.com`",
        "Pass certificate ARN to Helm release `ingress_certificate_arn` value",
        "Add Terraform output `acm_validation_records` showing DNS records to add to Cloudflare",
        "Terraform fmt passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Depends on US-004. Certificate ARN flows to Helm ingress config."
    },
    {
      "id": "US-006",
      "title": "Add ESO CRD Validation Check",
      "description": "As a DevOps engineer, I want Terraform to fail fast with helpful error messages when ESO is not installed.",
      "acceptanceCriteria": [
        "Add `kubernetes_resource` data source to check for ESO CRD existence",
        "Use `external-secrets.io` API group to validate ESO is installed",
        "Add local with precondition that fails with clear error message if CRD not found",
        "Error message includes link to `docs/troubleshooting/eso-not-found.md`",
        "Terraform fmt passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "ESO is deployed by o11y-tf. Fail fast if missing."
    },
    {
      "id": "US-007",
      "title": "Create ClusterSecretStore Resource",
      "description": "As a DevOps engineer, I want a ClusterSecretStore created by Terraform so ExternalSecret resources can fetch secrets from AWS Secrets Manager.",
      "acceptanceCriteria": [
        "Add `kubernetes_manifest` resource for ClusterSecretStore in main.tf",
        "ClusterSecretStore named `aws-secrets-manager`",
        "Configured with `provider: aws` and `service: SecretsManager`",
        "Region set to `us-east-2`",
        "References IRSA service account from secrets module for authentication",
        "Depends on ESO validation check from US-006",
        "Terraform fmt passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Depends on US-006. Must match name expected by Helm chart."
    },
    {
      "id": "US-008",
      "title": "Update Secrets Module for App Secrets",
      "description": "As a DevOps engineer, I want Terraform to reference the existing app-secrets in Secrets Manager.",
      "acceptanceCriteria": [
        "Update secrets module to reference `medic/{env}/app-secrets` secret path",
        "Add data source to read existing secret (created manually)",
        "Update ExternalSecret configuration in Helm values to include all secret keys",
        "Keys: MEDIC_SECRETS_KEY, MEDIC_WEBHOOK_SECRET, SLACK_API_TOKEN, SLACK_CHANNEL_ID, SLACK_SIGNING_SECRET, PAGERDUTY_ROUTING_KEY",
        "Terraform fmt passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Secrets already created in AWS. Terraform just references them."
    },
    {
      "id": "US-009",
      "title": "Update CD Pipeline Triggers",
      "description": "As a developer, I want PRs to deploy to dev and merges to main to deploy to prod.",
      "acceptanceCriteria": [
        "Update `cd-eks.yml` to trigger on `pull_request` to main for dev deployment",
        "Update `cd-eks.yml` to trigger on `push` to main for prod deployment",
        "Add `skip_dev` input option (default: true) for workflow_dispatch",
        "Dev deployment job has `if: inputs.skip_dev != true` condition",
        "Prod deployment requires GitHub Environment approval",
        "YAML lint passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "PR→dev, merge→prod. Skip dev by default until cluster exists."
    },
    {
      "id": "US-010",
      "title": "Create ESO Troubleshooting Documentation",
      "description": "As a DevOps engineer, I want troubleshooting documentation for when ESO is not found.",
      "acceptanceCriteria": [
        "Create `docs/troubleshooting/eso-not-found.md`",
        "Document that ESO is deployed by o11y-tf",
        "Include steps to verify ESO is installed (`kubectl get crd externalsecrets.external-secrets.io`)",
        "Include resolution steps if ESO is missing",
        "Link to o11y-tf repository for ESO deployment"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Referenced by error message in US-006."
    },
    {
      "id": "US-011",
      "title": "Create Deployment Prerequisites Documentation",
      "description": "As a DevOps engineer, I want clear documentation of all deployment prerequisites.",
      "acceptanceCriteria": [
        "Create `docs/deployment-prerequisites.md`",
        "Document GitHub secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY",
        "Document GitHub variables: TF_STATE_BUCKET, TF_STATE_KEY, TF_STATE_DYNAMODB_TABLE",
        "Document GitHub Environments: dev (no approval), prod (requires approval)",
        "Document external dependencies: o11y-tf cluster, ESO, ALB Controller (shared)",
        "Document Cloudflare DNS setup for ACM certificate validation",
        "Include architecture diagram (ASCII or mermaid) showing component relationships"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Comprehensive setup guide for new team members."
    },
    {
      "id": "US-012",
      "title": "Update README with Deployment Instructions",
      "description": "As a developer, I want the README updated with deployment workflow information.",
      "acceptanceCriteria": [
        "Add 'Deployment' section to README.md",
        "Document PR→dev, merge→prod workflow",
        "Link to `docs/deployment-prerequisites.md` for setup",
        "Link to `docs/troubleshooting/eso-not-found.md` for common issues",
        "Document multi-region architecture (ECR us-east-1, EKS us-east-2)"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Final documentation step. Links to detailed docs."
    }
  ]
}
